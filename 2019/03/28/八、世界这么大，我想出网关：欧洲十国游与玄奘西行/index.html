<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/siir.jpg?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/siir.jpg?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/siir.jpg?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"always","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前几节，我主要跟你讲了宿舍里和办公室里用到的网络协议。你已经有了一些基础，是时候去外网逛逛了！">
<meta name="keywords" content="计算机网络">
<meta property="og:type" content="article">
<meta property="og:title" content="八、世界这么大，我想出网关：欧洲十国游与玄奘西行">
<meta property="og:url" content="http://yoursite.com/2019/03/28/八、世界这么大，我想出网关：欧洲十国游与玄奘西行/index.html">
<meta property="og:site_name" content="Siir">
<meta property="og:description" content="前几节，我主要跟你讲了宿舍里和办公室里用到的网络协议。你已经有了一些基础，是时候去外网逛逛了！">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/79/fc/798467df661ecf5632d67b9c58bc53fc.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/d5/8f/d54cb2140c25831d6ec9b3e505796a8f.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/01/7f/016120f1bf46100812f1d1ccec1e517f.jpg">
<meta property="og:updated_time" content="2019-03-30T13:37:22.896Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="八、世界这么大，我想出网关：欧洲十国游与玄奘西行">
<meta name="twitter:description" content="前几节，我主要跟你讲了宿舍里和办公室里用到的网络协议。你已经有了一些基础，是时候去外网逛逛了！">
<meta name="twitter:image" content="https://static001.geekbang.org/resource/image/79/fc/798467df661ecf5632d67b9c58bc53fc.jpg">






  <link rel="canonical" href="http://yoursite.com/2019/03/28/八、世界这么大，我想出网关：欧洲十国游与玄奘西行/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>八、世界这么大，我想出网关：欧洲十国游与玄奘西行 | Siir</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Siir</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Schlagwörter</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Kategorien</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/28/八、世界这么大，我想出网关：欧洲十国游与玄奘西行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Siir">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://pic.superbed.cn/item/5c94a8cf3a213b0417e266a8">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Siir">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">八、世界这么大，我想出网关：欧洲十国游与玄奘西行

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-03-28 11:09:54" itemprop="dateCreated datePublished" datetime="2019-03-28T11:09:54+08:00">2019-03-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-03-30 21:37:22" itemprop="dateModified" datetime="2019-03-30T21:37:22+08:00">2019-03-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网络协议/" itemprop="url" rel="index"><span itemprop="name">网络协议</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前几节，我主要跟你讲了宿舍里和办公室里用到的网络协议。你已经有了一些基础，是时候去外网逛逛了！</p>
<a id="more"></a>
<h3 id="怎么在宿舍上网？"><a href="#怎么在宿舍上网？" class="headerlink" title="怎么在宿舍上网？"></a>怎么在宿舍上网？</h3><p>还记得咱们在宿舍的时候买了台交换机，几台机器组了一个局域网打游戏吗？可惜啊，只能打局域网的游戏，不能上网啊！盼啊盼啊，终于盼到大二，允许宿舍开通网络了。学校给每个宿舍的网口分配了一个 <font size="3" color="red">IP</font> 地址。这个 <font size="3" color="red">IP</font> 是校园网的 <font size="3" color="red">IP</font>，完全由网管部门控制。<font size="3" color="red">宿舍网的IP</font> 地址多为 <font size="3" color="red">192.168.1.x</font>。<font size="3" color="red">校园网的 IP</font> 地址，假设是 <font size="3" color="red">10.10.x.x</font>。</p>

<p>这个时候，你要在宿舍上网，有两个办法：</p>

<p>第一个办法，让你们宿舍长再买一个网卡。这个时候，你们宿舍长的电脑里就有两张网卡。一张网卡的线插到你们宿舍的交换机上，另一张网卡的线插到校园网的网口。而且，这张新的网卡的 IP 地址要按照学校网管部门分配的配置，不然上不了网。<font size="3" color="red">这种情况下，如果你们宿舍的人要上网，就需要一直开着宿舍长的电脑。</font></p>

<p>第二个办法，你们共同出钱买个家庭路由器（反正当时我们买不起）。家庭路由器会有内网网口和外网网口。把外网网口的线插到校园网的网口上，将这个外网网口配置成和网管部的一样。内网网口连上你们宿舍的所有的电脑。<font size="3" color="red">这种情况下，如果你们宿舍的人要上网，就需要一直开着路由器。</font></p>

<p>这两种方法其实是一样的。只不过第一种方式，让你的宿舍长的电脑，变成一个有多个口的路由器而已。而你买的家庭路由器，里面也跑着程序，和你宿舍长电脑里的功能一样，只不过是一个嵌入式的系统。</p>

<p>当你的宿舍长能够上网之后，接下来，就是其他人的电脑怎么上网的问题。这就需要配置你们的<font size="3" color="red">网卡。</font>当然 <font size="3" color="red">DHCP</font> 是可以默认配置的。在进行网卡配置的时候，除了 <font size="3" color="red">IP 地址</font>，还需要配置一个<font size="3" color="red">Gateway</font>的东西，这个就是<font size="3" color="red">网关</font>。</p>

<h3 id="你了解-MAC-头和-IP-头的细节吗？"><a href="#你了解-MAC-头和-IP-头的细节吗？" class="headerlink" title="你了解 MAC 头和 IP 头的细节吗？"></a>你了解 MAC 头和 IP 头的细节吗？</h3><p>一旦配置了 <font size="3" color="red">IP 地址</font>和<font size="3" color="red">网关</font>，往往就能够指定目标地址进行访问了。由于在<font size="3" color="red">跨网关</font>访问的时候，牵扯到 <font size="3" color="red">MAC 地址</font>和 <font size="3" color="red">IP 地址</font>的变化，这里有必要详细描述一下 <font size="3" color="red">MAC 头</font>和 <font size="3" color="red">IP 头</font>的细节。</p>

<p><img src="https://static001.geekbang.org/resource/image/79/fc/798467df661ecf5632d67b9c58bc53fc.jpg" alt="image"></p>
<p>在 <font size="3" color="red">MAC</font> 头里面，先是<font size="3" color="red">目标 MAC 地址</font>，然后是<font size="3" color="red">源 MAC 地址</font>，然后有一个<font size="3" color="red">协议类型</font>，用来说明里面是 <font size="3" color="red">IP 协议</font>。<font size="3" color="red">IP 头</font>里面的版本号，目前主流的还是 <font size="3" color="red">IPv4</font>，服务类型 <font size="3" color="red">TOS</font> 在第三节讲 <font size="3" color="red">ip addr</font> 命令的时候讲过，<font size="3" color="red">TTL</font> 在第 7 节讲 <font size="3" color="red">ICMP</font> 协议的时候讲过。另外，还有 8 位标识协议。这里到了下一层的协议，也就是，是 <font size="3" color="red">TCP</font> 还是 <font size="3" color="red">UDP</font>。最重要的就是<font size="3" color="red">源 IP</font> 和<font size="3" color="red">目标 IP</font>。先是<font size="3" color="red">源 IP 地址</font>，然后是<font size="3" color="red">目标 IP 地址</font>。</p>

<p>在任何一台机器上，当要访问另一个 <font size="3" color="red">IP</font> 地址的时候，都会先判断，这个<font size="3" color="red">目标 IP</font> 地址，和<font size="3" color="red">当前机器的 IP</font> 地址，是否在同一个<font size="3" color="red">网段</font>。怎么判断同一个网段呢？需要 <font size="3" color="red">CIDR</font> 和<font size="3" color="red">子网掩码</font>，这个在第三节的时候也讲过了。</p>

<p><strong>如果是同一个网段</strong>，例如，你访问你旁边的兄弟的电脑，那就没网关什么事情，直接将源地址和目标地址放入 <font size="3" color="red">IP</font> 头中，然后通过 <font size="3" color="red">ARP</font> 获得<font size="3" color="red"> MAC</font> 地址，将<font size="3" color="red">源 MAC</font> 和<font size="3" color="red">目的 MAC</font> 放入 <font size="3" color="red">MAC</font> 头中，发出去就可以了。</p>

<p><strong>如果不是同一网段</strong>，例如，你要访问你们校园网里面的 BBS，该怎么办？这就需要发往默认网关 <font size="3" color="red">Gateway</font>。Gateway 的地址一定是和<font size="3" color="red">源 IP</font> 地址是一个<font size="3" color="red">网段</font>的。往往不是第一个，就是第二个。例如 <font size="3" color="red">192.168.1.0/24</font> 这个网段，<font size="3" color="red">Gateway</font> 往往会是 <font size="3" color="red">192.168.1.1/24</font> 或者 <font size="3" color="red">192.168.1.2/24</font>。</p>

<p>如何发往默认<font size="3" color="red">网关</font>呢？<font size="3" color="red">网关</font>不是和<font size="3" color="red">源 IP</font> 地址是一个网段的么？这个过程就和发往同一个网段的其他机器是一样的：将源地址和目标 IP 地址放入 IP 头中，通过 ARP 获得网关的 MAC 地址，将源 MAC 和网关的 MAC 放入 MAC 头中，发送出去。网关所在的端口，例如 192.168.1.1/24 将网络包收进来，然后接下来怎么做，就完全看网关的了。</p>

<p><strong><font size="3" color="red">网关</font>往往是一个<font size="3" color="red">路由器</font>，是一个三层转发的设备。</strong>啥叫三层设备？前面也说过了，就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。</p>

<p>在你的宿舍里面，网关就是你宿舍长的电脑。一个路由器往往有多个网口，如果是一台服务器做这个事情，则就有多个网卡，其中一个网卡是和<font size="3" color="red">源 IP</font> 同网段的。</p>

<p>很多情况下，人们把网关就叫作路由器。其实不完全准确，而另一种比喻更加恰当：<strong><font size="3" color="red">路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址相同的网段，每只手都是它握住的那个局域网的网关。</font></strong></p>

<p>任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下 <font size="3" color="red">MAC 头</font>和 <font size="3" color="red">IP 头</font>，看看，根据自己的<font size="3" color="red">路由算法</font>，选择另一只手，加上 <font size="3" color="red">IP </font>头和 <font size="3" color="red">MAC</font> 头，然后扔出去。</p>

<h3 id="静态路由是什么？"><a href="#静态路由是什么？" class="headerlink" title="静态路由是什么？"></a>静态路由是什么？</h3><p>这个时候，问题来了，该选择哪一只手？<font size="3" color="red">IP 头</font>和 <font size="3" color="red">MAC 头</font>加什么内容，哪些变、哪些不变呢？这个问题比较复杂，大致可以分为两类，一个是<strong><font size="3" color="red">静态路由</font></strong>，一个是<strong><font size="3" color="red">动态路由</font></strong>。动态路由下一节我们详细地讲。这一节我们先说静态路由。</p>

<p><strong>静态路由，其实就是在路由器上，配置一条一条规则。</strong>这些规则包括：想访问 BBS 站（它肯定有个网段），从 2 号口出去，下一跳是 IP2；想访问教学视频站（它也有个自己的网段），从 3 号口出去，下一跳是 IP3，然后保存在路由器里。</p>

<p>每当要选择从哪只手抛出去的时候，就一条一条的匹配规则，找到符合的规则，就按规则中设置的那样，从某个口抛出去，找下一跳 IPX。</p>

<h3 id="IP-头和-MAC-头哪些变、哪些不变？"><a href="#IP-头和-MAC-头哪些变、哪些不变？" class="headerlink" title="IP 头和 MAC 头哪些变、哪些不变？"></a>IP 头和 MAC 头哪些变、哪些不变？</h3><p>对于 <font size="3" color="red">IP 头</font>和 <font size="3" color="red">MAC</font> 头哪些变、哪些不变的问题，可以分两种类型。我把它们称为“<strong>欧洲十国游”型</strong>和“<strong>玄奘西行”型</strong>。</p>

<p>之前我说过，<font size="3" color="red">MAC</font> 地址是一个局域网内才有效的地址。因而，<font size="3" color="red">MAC 地址只要过网关，就必定会改变，因为已经换了局域网</font>。两者主要的区别在于 <font size="3" color="red">IP</font> 地址是否改变。<font size="3" color="red">不改变 IP</font> 地址的网关，我们称为<strong><font size="3" color="red">转发网关</font>；</strong><font size="3" color="red">改变 IP 地址的网关</font>，我们称为<strong><font size="3" color="red">NAT 网关</font></strong>。</p>

<h4 id="“欧洲十国游”型"><a href="#“欧洲十国游”型" class="headerlink" title="“欧洲十国游”型"></a>“欧洲十国游”型</h4><p>结合这个图，我们先来看“欧洲十国游”型。</p>

<p><img src="https://static001.geekbang.org/resource/image/d5/8f/d54cb2140c25831d6ec9b3e505796a8f.jpg" alt="image"></p>
<p><font size="3" color="red">服务器 A</font> 要访问<font size="3" color="red">服务器 B</font>。首先，<font size="3" color="red">服务器 A</font> 会思考，<font size="3" color="red">192.168.4.101</font> 和我不是一个网段的，因而需要先发给网关。那网关是谁呢？已经静态配置好了，网关是 <font size="3" color="red">192.168.1.1</font>。网关的 <font size="3" color="red">MAC</font> 地址是多少呢？发送 <font size="3" color="red">ARP</font> 获取网关的 <font size="3" color="red">MAC</font> 地址，然后发送包。包的内容是这样的：</p>

<ul><br><li><p>源 MAC：服务器 A 的 MAC</p><br></li><br><li><p>目标 MAC：192.168.1.1 这个网口的 MAC</p><br></li><br><li><p>源 IP：192.168.1.101</p><br></li><br><li><p>目标 IP：192.168.4.101</p><br></li><br></ul>

<p>包到达 <font size="3" color="red">192.168.1.1</font> 这个网口，发现 <font size="3" color="red">MAC</font> 一致，将包收进来，开始思考往哪里转发。</p><br><p>在<font size="3" color="red">路由器 A</font> 中配置了静态路由之后，要想访问 <font size="3" color="red">192.168.4.0/24</font>，要从 <font size="3" color="red">192.168.56.1</font> 这个口出去，下一跳为 <font size="3" color="red">192.168.56.2</font>。</p><br><p>于是，<font size="3" color="red">路由器 A</font> 思考的时候，匹配上了这条路由，要从 <font size="3" color="red">192.168.56.1</font> 这个口发出去，发给 <font size="3" color="red">192.168.56.2</font>，那 <font size="3" color="red">192.168.56.2</font> 的 <font size="3" color="red">MAC</font> 地址是多少呢？<font size="3" color="red">路由器 A</font> 发送<font size="3" color="red"> ARP</font> 获取 <font size="3" color="red">192.168.56.2</font> 的 <font size="3" color="red">MAC</font> 地址，然后发送包。包的内容是这样的：</p>

<ul><br><li><p>源 MAC：192.168.56.1 的 MAC 地址</p><br></li><br><li><p>目标 MAC：192.168.56.2 的 MAC 地址</p><br></li><br><li><p>源 IP：192.168.1.101</p><br></li><br><li><p>目标 IP：192.168.4.101</p><br></li><br></ul>

<p>包到达 <font size="3" color="red">192.168.56.2</font> 这个网口，发现 <font size="3" color="red">MAC</font> 一致，将包收进来，开始思考往哪里转发。</p><br><p>在<font size="3" color="red">路由器 B</font> 中配置了<font size="3" color="red">静态路由</font>，要想访问 <font size="3" color="red">192.168.4.0/24</font>，要从 <font size="3" color="red">192.168.4.1</font> 这个口出去，没有下一跳了。因为我右手这个网卡，就是这个网段的，我是最后一跳了。</p><br><p>于是，<font size="3" color="red">路由器 B</font> 思考的时候，匹配上了这条路由，要从 <font size="3" color="red">192.168.4.1</font> 这个口发出去，发给 <font size="3" color="red">192.168.4.101</font>。那 <font size="3" color="red">192.168.4.101</font> 的 <font size="3" color="red">MAC</font> 地址是多少呢？<font size="3" color="red">路由器 B</font> 发送 <font size="3" color="red">ARP</font> 获取 <font size="3" color="red">192.168.4.101</font> 的 <font size="3" color="red">MAC 地址</font>，然后发送包。包的内容是这样的：</p><br><ul><br><li><p>源 MAC：192.168.4.1 的 MAC 地址</p><br></li><br><li><p>目标 MAC：192.168.4.101 的 MAC 地址</p><br></li><br><li><p>源 IP：192.168.1.101</p><br></li><br><li><p>目标 IP：192.168.4.101</p><br></li><br></ul><br><br><p>包到达服务器 B，MAC 地址匹配，将包收进来。</p><br><p>通过这个过程可以看出，每到一个新的局域网，MAC 都是要变的，但是 IP 地址都不变。在 IP 头里面，不会保存任何网关的 IP 地址。<strong>所谓的下一跳是，某个 IP 要将这个 IP 地址转换为 MAC 放入 MAC 头。</strong></p>

<p>之所以将这种模式比喻称为欧洲十国游，是因为<font size="3" color="red">在整个过程中</font>，<font size="3" color="red">IP 头</font>里面的地址都是<font size="3" color="red">不变</font>的。IP 地址在三个局域网都可见，在三个局域网之间的网段都不会冲突。在三个网段之间传输包，IP 头不改变。<font size="3" color="red">这就像在欧洲各国之间旅游，一个签证就能搞定</font>。<br><br><br><br>#### “玄奘西行”型<br><br><img src="https://static001.geekbang.org/resource/image/01/7f/016120f1bf46100812f1d1ccec1e517f.jpg" alt="image"><br><br></p><p>我们再来看“玄奘西行”型。</p><br><p>这里遇见的第一个问题是，局域网之间没有商量过，<font size="3" color="red">各定各的网段</font>，因而 <font size="3" color="red">IP 段冲突</font>了。最左面大唐的地址是 <font size="3" color="red">192.168.1.101</font>，最右面印度的地址也是 <font size="3" color="red">192.168.1.101</font>，如果<font size="3" color="red">单从 IP</font> 地址上看，简直是自己访问自己，其实<font size="3" color="red">是大唐的 192.168.1.101 要访问印度的 192.168.1.101</font>。</p>

<p>怎么解决这个问题呢？既然局域网之间没有商量过，你们各管各的，那到国际上，也即中间的局域网里面，就需要使用另外的地址。就像出国，不能用咱们自己的身份证，而要改用护照一样，玄奘西游也要拿着专门取经的通关文牒，而不能用自己国家的身份证。</p>

<p>首先，<font size="3" color="red">目标服务器 B</font> 在国际上<font size="3" color="red">要有一个国际</font>的<font size="3" color="red">身份</font>，我们给它一个 <font size="3" color="red">192.168.56.2</font>。在<font size="3" color="red">网关 B</font> 上，我们记下来，<font size="3" color="red">国际身份 192.168.56.2</font> 对应<font size="3" color="red">国内身份 192.168.1.101</font>。凡是要访问<font size="3" color="red"> 192.168.56.2</font>，都转成<font size="3" color="red"> 192.168.1.101</font>。</p><br><p>于是，<font size="3" color="red">源服务器 A</font> 要访问<font size="3" color="red">目标服务器 B</font>，要指定的<font size="3" color="red">目标地址为 192.168.56.2</font>。这是它的国际身份。<font size="3" color="red">服务器 A</font> 想，<font size="3" color="red">192.168.56.2 </font>和我不是一个网段的，因而需要发给<font size="3" color="red">网关</font>，网关是谁？已经静态配置好了，网关是 <font size="3" color="red">192.168.1.1</font>，网关的 <font size="3" color="red">MAC</font> 地址是多少？发送 <font size="3" color="red">ARP</font> 获取网关的 MAC 地址，然后发送包。包的内容是这样的：</p>

<ul><br><li><p>源 MAC：服务器 A 的 MAC</p><br></li><br><li><p>目标 MAC：192.168.1.1 这个网口的 MAC</p><br></li><br><li><p>源 IP：192.168.1.101</p><br></li><br><li><p>目标 IP：192.168.56.2</p><br></li><br></ul>

<p>包到达 <font size="3" color="red">192.168.1.1</font> 这个网口，发现 <font size="3" color="red">MAC</font> 一致，将包收进来，开始思考往哪里转发。</p><br><p>在<font size="3" color="red">路由器 A</font> 中配置了静态路由：要想访问 <font size="3" color="red">192.168.56.2/24</font>，要从 <font size="3" color="red">192.168.56.1</font> 这个口出去，没有下一跳了，因为我右手这个网卡，就是这个网段的，我是最后一跳了。</p><br><p>于是，<font size="3" color="red">路由器 A</font> 思考的时候，匹配上了这条路由，要从<font size="3" color="red"> 192.168.56.1 </font>这个口发出去，发给<font size="3" color="red"> 192.168.56.2</font>。那 <font size="3" color="red">192.168.56.2</font> 的 <font size="3" color="red">MAC</font> 地址是多少呢？<font size="3" color="red">路由器 A </font>发送 <font size="3" color="red">ARP</font> 获取 <font size="3" color="red">192.168.56.2</font> 的<font size="3" color="red"> MAC 地址</font>。</p><br><p>当网络包发送到中间的局域网的时候，<font size="3" color="red">服务器 A</font> 也需要有个国际身份，因而在国际上，<font size="3" color="red">源 IP 地址</font>也不能用 <font size="3" color="red">192.168.1.101</font>，需要改成<font size="3" color="red"> 192.168.56.1</font>。发送包的内容是这样的：</p>

<ul><br><li><p>源 MAC：192.168.56.1 的 MAC 地址</p><br></li><br><li><p>目标 MAC：192.168.56.2 的 MAC 地址</p><br></li><br><li><p>源 IP：192.168.56.1</p><br></li><br><li><p>目标 IP：192.168.56.2</p><br></li><br></ul>

<p>包到达 <font size="3" color="red">192.168.56.2</font> 这个网口，发现<font size="3" color="red"> MAC</font> 一致，将包收进来，开始思考往哪里转发。</p><br><p><font size="3" color="red">路由器 B</font> 是一个 <font size="3" color="red">NAT</font> 网关，它上面配置了，要访问国际身份 <font size="3" color="red">192.168.56.2</font> 对应国内身份 <font size="3" color="red">192.168.1.101</font>，于是<font size="3" color="red">改为访问 192.168.1.101</font>。</p><br><p>在<font size="3" color="red">路由器 B</font> 中配置了<font size="3" color="red">静态路由</font>：要想访问 <font size="3" color="red">192.168.1.0/24</font>，要从 <font size="3" color="red">192.168.1.1</font> 这个口出去，没有下一跳了，因为我右手这个网卡，就是这个网段的，我是最后一跳了。</p><br><p>于是，<font size="3" color="red">路由器 B</font> 思考的时候，匹配上了这条路由，要从 <font size="3" color="red">192.168.1.1</font> 这个口发出去，发给 <font size="3" color="red">192.168.1.101</font>。</p><br><p>那<font size="3" color="red"> 192.168.1.101 </font>的 <font size="3" color="red">MAC </font>地址是多少呢？<font size="3" color="red">路由器 B</font> 发送<font size="3" color="red"> ARP</font> 获取<font size="3" color="red"> 192.168.1.101</font> 的 <font size="3" color="red">MAC</font> 地址，然后发送包。内容是这样的：</p><br><ul><br><li><p>源 MAC：192.168.1.1 的 MAC 地址</p><br></li><br><li><p>目标 MAC：192.168.1.101 的 MAC 地址</p><br></li><br><li><p>源 IP：192.168.56.1</p><br></li><br><li><p>目标 IP：192.168.1.101</p><br></li><br></ul><br><br><p>包到达<font size="3" color="red">服务器 B</font>，<font size="3" color="red">MAC</font> 地址匹配，将包收进来。</p><br><p>从<font size="3" color="red">服务器 B</font> 接收的包可以看出，<font size="3" color="red">源 IP </font>为<font size="3" color="red">服务器 A</font> 的国际身份，因而发送返回包的时候，也发给这个国际身份，由<font size="3" color="red">路由器 A</font> 做 <font size="3" color="red">NAT</font>，转换为国内身份。</p>

<p>从这个过程可以看出，<font size="3" color="red">IP</font> 地址也会变。这个过程用英文说就是<strong><font size="3" color="red">Network Address Translation</font></strong>，简称<strong><font size="3" color="red">NAT</font></strong>。</p>

<p>其实这第二种方式我们经常见，现在大家每家都有家用路由器，家里的网段都是 192.168.1.x，所以你肯定访问不了你邻居家的这个私网的 IP 地址的。所以，当我们家里的包发出去的时候，都被家用路由器 NAT 成为了运营商的地址了。</p><br><p>很多办公室访问外网的时候，也是被 NAT 过的，因为不可能办公室里面的 IP 也是公网可见的，公网地址实在是太贵了，所以一般就是整个办公室共用一个到两个出口 IP 地址。你可以通过 <a href="https://www.whatismyip.com/" target="_blank" rel="noopener">https://www.whatismyip.com/</a> 查看自己的出口 IP 地址。</p>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>如果离开本局域网，就需要经过网关，网关是路由器的一个网口；</li>
<li>路由器是一个三层设备，里面有如何寻找下一跳的规则；</li>
<li>经过路由器之后 MAC 头要变，如果 IP 不变，相当于不换护照的欧洲旅游，如果 IP 变，相当于换护照的玄奘西行。</li>
</ul>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><ol><br><li>当在你家里要访问 163 网站的时候，你的包需要 NAT 成为公网 IP，返回的包又要 NAT 成你的私有 IP，返回包怎么知道这是你的请求呢？它怎么就这么智能的 NAT 成了你的 IP 而非别人的 IP 呢？</li><br><li>对于路由规则，这一节讲述了静态路由，需要手动配置，如果要自动配置，你觉得应该怎么办呢？</li><br></ol>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/计算机网络/" rel="tag"># 计算机网络</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/28/七、ICMP与ping：投石问路的侦察兵/" rel="next" title="七、ICMP与ping：投石问路的侦察兵">
                <i class="fa fa-chevron-left"></i> 七、ICMP与ping：投石问路的侦察兵
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/28/九、路由协议：西出网关无故人、敢问路在何方/" rel="prev" title="九、路由协议：西出网关无故人、敢问路在何方">
                九、路由协议：西出网关无故人、敢问路在何方 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://pic.superbed.cn/item/5c94a8cf3a213b0417e266a8" alt="Siir">
            
              <p class="site-author-name" itemprop="name">Siir</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">64</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">Kategorien</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">87</span>
                    <span class="site-state-item-name">schlagwörter</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/burning-shadow" title="GitHub &rarr; https://github.com/burning-shadow" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/6975656937" title="Weibo &rarr; https://weibo.com/6975656937" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#怎么在宿舍上网？"><span class="nav-number">1.</span> <span class="nav-text">怎么在宿舍上网？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#你了解-MAC-头和-IP-头的细节吗？"><span class="nav-number">2.</span> <span class="nav-text">你了解 MAC 头和 IP 头的细节吗？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#静态路由是什么？"><span class="nav-number">3.</span> <span class="nav-text">静态路由是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP-头和-MAC-头哪些变、哪些不变？"><span class="nav-number">4.</span> <span class="nav-text">IP 头和 MAC 头哪些变、哪些不变？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#“欧洲十国游”型"><span class="nav-number">4.1.</span> <span class="nav-text">“欧洲十国游”型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">5.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#思考"><span class="nav-number">6.</span> <span class="nav-text">思考</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Siir</span>

  

  
</div>


  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
